on:
  push:
    branches: master

name: R package (Windows)

jobs:
  Rpackage:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2
      - uses: conda-incubator/setup-miniconda@v2
        with:
          activate-environment: OmicSelector
          miniconda-version: "latest"

      - name: Install enviorment
        shell: bash -l {0}
        run: |
          pwd
          conda update --all
          conda install -c conda-forge mamba
          mamba install --channel "conda-forge" --channel "anaconda" --channel "r" python=3.9 conda-pack tensorflow-gpu keras jupyter jupytext numpy pandas r-base r-devtools r-rgl r-cairo r-rjava r-mnormt r-purrrogress r-xml libxml2 pandoc r-rjava opencv pkgconfig rtools
          echo "options(repos=structure(c(CRAN='http://cran.r-project.org')))" >> ~/.Rprofile
          Rscript -e 'update.packages(ask = F); install.packages(c("devtools","remotes")); remotes::install_cran("pkgdown");'
          Rscript -e 'devtools::source_url("https://raw.githubusercontent.com/kstawiski/OmicSelector/master/vignettes/setup.R")'
      - name: Install package
        shell: bash -l {0}
        run: R CMD INSTALL .

      - name: Check loading
        shell: bash -l {0}
        run: |
          Rscript -e 'library(OmicSelector); sessionInfo();'
          
      - name: Pack env
        shell: bash -l {0}
        run: | 
          conda pack -n OmicSelector -o OmicSelector_conda_pack_win.tar.gz
          
      - name: ðŸ“‚ Upload to deploy.konsta.com.pl
        uses: SamKirkland/FTP-Deploy-Action@4.0.0
        with:
          server: konsta.com.pl
          username: deploy
          password: ${{ secrets.PASSWORD }}
          server-dir: ./Deploy/OmicSelector-win/
